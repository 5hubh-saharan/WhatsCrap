<!-- app/templates/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsCrap</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- æ·»åŠ è®¾ç½®æŒ‰é’®æ ·å¼ -->
    <style>
        .settings-btn {
            background-color: #4a90e2;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        
        .settings-btn:hover {
            background-color: #357ae8;
        }
    </style>
</head>

<body id="appBody">
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="brand">WhatsCrap ðŸ’¬</a>
        </div>
        <div class="nav-center">
            {% if request.session.get('user_id') %}
            <!-- Background color selector -->
            <div class="background-selector">
                <label for="bgColorSelect">Background:</label>
                <select id="bgColorSelect" class="bg-select">
                    <option value="#f5f5f5">Light Gray</option>
                    <option value="#ffffff">White</option>
                    <option value="#252a34">Dark Blue</option>
                    <option value="#59A52C">Green</option>
                    <option value="#3a4252">Gray Blue</option>
                    <option value="#101216">Dark Gray</option>
                    <option value="#6fca3a">Light Green</option>
                    <option value="#1a1a2e">Navy</option>
                    <option value="#0f3460">Deep Blue</option>
                    <option value="#f0f8ff">Alice Blue</option>
                    <option value="#faf0e6">Linen</option>
                    <option value="#fff5ee">Sea Shell</option>
                    <option value="#2c003e">Purple</option>
                    <option value="#1b1b2f">Dark Purple</option>
                    <option value="#162447">Midnight</option>
                </select>
                <button id="resetBg" class="reset-btn">Reset</button>
            </div>
            {% endif %}
        </div>
        <div class="nav-right">
            {% if request.session.get('user_id') %}
                <span class="welcome-message">Welcome, {{ request.session.get('username', 'User') }}!</span>
                <div id="connectionIndicator" class="connection-indicator connected" title="Connected">
                    <span class="indicator-dot"></span>
                </div>
                <a href="/chat/rooms">Rooms</a>
                <a href="/settings" class="settings-btn">Settings</a>
                <a href="/auth/logout" class="logout-btn">Logout</a>
            {% else %}
                <a href="/auth/login">Login</a>
                <a href="/auth/register">Register</a>
            {% endif %}
        </div>
    </nav>

    <main class="container">
        {% block content %}
        {% endblock %}
    </main>
    
    <!-- Keyboard shortcut tips -->
    <div class="keyboard-hint container">
        <small>
            <kbd>Enter</kbd> to send â€¢ 
            <kbd>/</kbd> to focus input
        </small>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bgSelect = document.getElementById('bgColorSelect');
            const resetBtn = document.getElementById('resetBg');
            const appBody = document.getElementById('appBody');
            
            // ä»Ž localStorage èŽ·å–ç”¨æˆ·è®¾ç½®
            let userSettings = {};
            try {
                userSettings = JSON.parse(localStorage.getItem('user_settings')) || {};
            } catch (e) {
                userSettings = {};
            }
            
            // ä»Ž session èŽ·å–èƒŒæ™¯é¢œè‰²
            let savedBg = localStorage.getItem('appBackgroundColor');
            
            // å¦‚æžœç”¨æˆ·è®¾ç½®ä¸­æœ‰ä¸»é¢˜é¢œè‰²ï¼Œä½¿ç”¨å®ƒ
            if (userSettings.theme_color) {
                savedBg = userSettings.theme_color;
                localStorage.setItem('appBackgroundColor', userSettings.theme_color);
            }
            
            if (savedBg) {
                appBody.style.backgroundColor = savedBg;
                if (bgSelect) bgSelect.value = savedBg;
                updateTextColors(savedBg);
                updateDarkModeClass(savedBg);
            }
            
            // åº”ç”¨æ°”æ³¡é¢œè‰²è®¾ç½®
            applyBubbleColors(userSettings);
            
            // ç›‘å¬èƒŒæ™¯é¢œè‰²é€‰æ‹©å™¨å˜åŒ–
            if (bgSelect) {
                bgSelect.addEventListener('change', function() {
                    const selectedColor = this.value;
                    appBody.style.backgroundColor = selectedColor;
                    updateTextColors(selectedColor);
                    updateDarkModeClass(selectedColor);
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('appBackgroundColor', selectedColor);
                    
                    // æ›´æ–°ç”¨æˆ·è®¾ç½®
                    userSettings.theme_color = selectedColor;
                    localStorage.setItem('user_settings', JSON.stringify(userSettings));
                    
                    // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
                    updateSettingsOnServer(userSettings);
                });
            }
            
            // é‡ç½®æŒ‰é’®
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    localStorage.removeItem('appBackgroundColor');
                    localStorage.removeItem('user_settings');
                    appBody.style.backgroundColor = '';
                    appBody.classList.remove('dark-background');
                    if (bgSelect) bgSelect.value = '#f5f5f5';
                    updateTextColors('#f5f5f5');
                    resetFormStyles();
                    
                    // é‡ç½®æœåŠ¡å™¨è®¾ç½®
                    fetch('/settings/reset', { method: 'GET' });
                });
            }
            
            // åº”ç”¨æ°”æ³¡é¢œè‰²
            function applyBubbleColors(settings) {
                if (!settings) return;
                
                const root = document.documentElement;
                
                if (settings.my_bubble_color) {
                    root.style.setProperty('--my-bubble-color', settings.my_bubble_color);
                    const myBubbleGradient = `linear-gradient(135deg, ${settings.my_bubble_color} 0%, ${adjustColor(settings.my_bubble_color, -30)} 100%)`;
                    root.style.setProperty('--my-bubble-gradient', myBubbleGradient);
                }
                
                if (settings.other_bubble_color) {
                    root.style.setProperty('--other-bubble-color', settings.other_bubble_color);
                    const otherBubbleGradient = `linear-gradient(135deg, ${settings.other_bubble_color} 0%, ${adjustColor(settings.other_bubble_color, -30)} 100%)`;
                    root.style.setProperty('--other-bubble-gradient', otherBubbleGradient);
                }
                
                // æ›´æ–°é¡µé¢ä¸Šçš„æ°”æ³¡æ ·å¼
                updateBubbleStyles();
            }
            
            // è°ƒæ•´é¢œè‰²äº®åº¦
            function adjustColor(color, amount) {
                const clamp = (value) => Math.min(255, Math.max(0, value));
                
                if (color.startsWith('#')) {
                    let r = parseInt(color.substring(1, 3), 16);
                    let g = parseInt(color.substring(3, 5), 16);
                    let b = parseInt(color.substring(5, 7), 16);
                    
                    r = clamp(r + amount);
                    g = clamp(g + amount);
                    b = clamp(b + amount);
                    
                    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                }
                return color;
            }
            
            // æ›´æ–°æ°”æ³¡æ ·å¼
            function updateBubbleStyles() {
                const myBubbles = document.querySelectorAll('.message-item.my-message .message-bubble');
                const otherBubbles = document.querySelectorAll('.message-item.other-message .message-bubble');
                
                myBubbles.forEach(bubble => {
                    bubble.style.background = 'var(--my-bubble-gradient)';
                });
                
                otherBubbles.forEach(bubble => {
                    bubble.style.background = 'var(--other-bubble-gradient)';
                });
            }
            
            // æ›´æ–°è®¾ç½®åˆ°æœåŠ¡å™¨
            async function updateSettingsOnServer(settings) {
                try {
                    const response = await fetch('/settings/api/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    const result = await response.json();
                    if (!result.success) {
                        console.error('Failed to update settings:', result.error);
                    }
                } catch (error) {
                    console.error('Failed to update settings:', error);
                }
            }
            
            // æ£€æŸ¥ URL å‚æ•°æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                const message = urlParams.get('message') || 'Settings saved successfully!';
                showToast(message, 'success');
            }
            
            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background-color: ${type === 'success' ? '#4caf50' : '#2196f3'};
                    color: white;
                    border-radius: 4px;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // æ·»åŠ  CSS åŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // åŽŸæœ‰å‡½æ•°
            function updateDarkModeClass(bgColor) {
                const color = bgColor.charAt(0) === '#' ? bgColor.substring(1, 7) : bgColor;
                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                
                if (brightness < 128) {
                    appBody.classList.add('dark-background');
                } else {
                    appBody.classList.remove('dark-background');
                }
            }
            
            function updateTextColors(bgColor) {
                const color = bgColor.charAt(0) === '#' ? bgColor.substring(1, 7) : bgColor;
                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                
                const containers = document.querySelectorAll('.container');
                containers.forEach(container => {
                    if (brightness < 128) {
                        container.style.color = '#ffffff';
                    } else {
                        container.style.color = '#333333';
                    }
                });
                
                updateFormStyles(brightness);
            }
            
            function updateFormStyles(brightness) {
                const inputs = document.querySelectorAll('input:not(.bg-select), textarea');
                const selects = document.querySelectorAll('select:not(.bg-select)');
                
                inputs.forEach(input => {
                    if (brightness < 128) {
                        input.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                        input.style.color = '#ffffff';
                        input.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                        input.style.setProperty('--placeholder-color', 'rgba(255, 255, 255, 0.5)');
                    } else {
                        input.style.backgroundColor = '';
                        input.style.color = '';
                        input.style.borderColor = '';
                        input.style.setProperty('--placeholder-color', '');
                    }
                });
                
                selects.forEach(select => {
                    if (brightness < 128) {
                        select.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                        select.style.color = '#ffffff';
                        select.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    } else {
                        select.style.backgroundColor = '';
                        select.style.color = '';
                        select.style.borderColor = '';
                    }
                });
            }
            
            function resetFormStyles() {
                const inputs = document.querySelectorAll('input:not(.bg-select), textarea');
                const selects = document.querySelectorAll('select:not(.bg-select)');
                
                inputs.forEach(input => {
                    input.style.backgroundColor = '';
                    input.style.color = '';
                    input.style.borderColor = '';
                    input.style.setProperty('--placeholder-color', '');
                });
                
                selects.forEach(select => {
                    select.style.backgroundColor = '';
                    select.style.color = '';
                    select.style.borderColor = '';
                });
                
                const containers = document.querySelectorAll('.container');
                containers.forEach(container => {
                    container.style.color = '';
                });
            }
        });
    </script>
</body>
</html>