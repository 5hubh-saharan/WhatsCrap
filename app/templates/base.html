<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsCrap</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body id="appBody">
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="brand">WhatsCrap ğŸ’¬</a>
        </div>
        <div class="nav-center">
            {% if request.session.get('user_id') %}
            <!-- èƒŒæ™¯é¢œè‰²é€‰æ‹©å™¨ -->
            <div class="background-selector">
                <label for="bgColorSelect">Background:</label>
                <select id="bgColorSelect" class="bg-select">
                    <option value="#f5f5f5">Light Gray</option>
                    <option value="#ffffff">White</option>
                    <option value="#252a34">Dark Blue</option>
                    <option value="#59A52C">Green</option>
                    <option value="#3a4252">Gray Blue</option>
                    <option value="#101216">Dark Gray</option>
                    <option value="#6fca3a">Light Green</option>
                    <option value="#1a1a2e">Navy</option>
                    <option value="#0f3460">Deep Blue</option>
                    <option value="#f0f8ff">Alice Blue</option>
                    <option value="#faf0e6">Linen</option>
                    <option value="#fff5ee">Sea Shell</option>
                    <option value="#2c003e">Purple</option>
                    <option value="#1b1b2f">Dark Purple</option>
                    <option value="#162447">Midnight</option>
                </select>
                <button id="resetBg" class="reset-btn">Reset</button>
            </div>
            {% endif %}
        </div>
        <div class="nav-right">
            {% if request.session.get('user_id') %}
                <span class="welcome-message">Welcome, {{ request.session.get('username', 'User') }}!</span>
                <div id="connectionIndicator" class="connection-indicator connected" title="Connected">
                    <span class="indicator-dot"></span>
                </div>
                <a href="/chat/rooms">Rooms</a>
                <a href="/auth/logout" class="logout-btn">Logout</a>
            {% else %}
                <a href="/auth/login">Login</a>
                <a href="/auth/register">Register</a>
            {% endif %}
        </div>
    </nav>

    <main class="container">
        {% block content %}
        {% endblock %}
    </main>
    
    <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
    <div class="keyboard-hint container">
        <small>
            <kbd>Enter</kbd> to send â€¢ 
            <kbd>/</kbd> to focus input
        </small>
    </div>

    <script>
        // è®¾ç½®èƒŒæ™¯é¢œè‰²é€‰æ‹©å™¨ï¼ˆåº”ç”¨åˆ°æ•´ä¸ªçª—å£ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const bgSelect = document.getElementById('bgColorSelect');
            const resetBtn = document.getElementById('resetBg');
            const appBody = document.getElementById('appBody');
            
            if (!bgSelect || !resetBtn || !appBody) return;
            
            // ä»localStorageè¯»å–ä¿å­˜çš„èƒŒæ™¯é¢œè‰²
            const savedBg = localStorage.getItem('appBackgroundColor');
            if (savedBg) {
                appBody.style.backgroundColor = savedBg;
                bgSelect.value = savedBg;
                updateTextColors(savedBg);
                updateDarkModeClass(savedBg);
            }
            
            // ç›‘å¬èƒŒæ™¯é¢œè‰²é€‰æ‹©å˜åŒ–
            bgSelect.addEventListener('change', function() {
                const selectedColor = this.value;
                appBody.style.backgroundColor = selectedColor;
                localStorage.setItem('appBackgroundColor', selectedColor);
                updateTextColors(selectedColor);
                updateDarkModeClass(selectedColor);
            });
            
            // é‡ç½®èƒŒæ™¯é¢œè‰²
            resetBtn.addEventListener('click', function() {
                localStorage.removeItem('appBackgroundColor');
                appBody.style.backgroundColor = '';
                appBody.classList.remove('dark-background');
                bgSelect.value = '#f5f5f5';
                updateTextColors('#f5f5f5');
                resetFormStyles();
            });
            
            // æ ¹æ®èƒŒæ™¯é¢œè‰²è°ƒæ•´æš—è‰²æ¨¡å¼ç±»
            function updateDarkModeClass(bgColor) {
                // è®¡ç®—èƒŒæ™¯äº®åº¦
                const color = bgColor.charAt(0) === '#' ? bgColor.substring(1, 7) : bgColor;
                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                
                // æ·»åŠ æˆ–ç§»é™¤æš—è‰²èƒŒæ™¯ç±»
                if (brightness < 128) {
                    appBody.classList.add('dark-background');
                } else {
                    appBody.classList.remove('dark-background');
                }
            }
            
            // æ ¹æ®èƒŒæ™¯é¢œè‰²è°ƒæ•´æ–‡å­—é¢œè‰²
            function updateTextColors(bgColor) {
                // è®¡ç®—èƒŒæ™¯äº®åº¦
                const color = bgColor.charAt(0) === '#' ? bgColor.substring(1, 7) : bgColor;
                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                
                // æ›´æ–°å®¹å™¨æ–‡å­—é¢œè‰²
                const containers = document.querySelectorAll('.container');
                containers.forEach(container => {
                    if (brightness < 128) {
                        container.style.color = '#ffffff';
                    } else {
                        container.style.color = '#333333';
                    }
                });
                
                // æ›´æ–°è¡¨å•è¾“å…¥æ¡†æ ·å¼
                updateFormStyles(brightness);
            }
            
            // æ›´æ–°è¡¨å•æ ·å¼
            function updateFormStyles(brightness) {
                const inputs = document.querySelectorAll('input:not(.bg-select), textarea');
                const selects = document.querySelectorAll('select:not(.bg-select)');
                
                // æ›´æ–°æ™®é€šè¾“å…¥æ¡†
                inputs.forEach(input => {
                    if (brightness < 128) {
                        input.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                        input.style.color = '#ffffff';
                        input.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                        input.style.setProperty('--placeholder-color', 'rgba(255, 255, 255, 0.5)');
                    } else {
                        input.style.backgroundColor = '';
                        input.style.color = '';
                        input.style.borderColor = '';
                        input.style.setProperty('--placeholder-color', '');
                    }
                });
                
                // æ›´æ–°é€‰æ‹©æ¡†
                selects.forEach(select => {
                    if (brightness < 128) {
                        select.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                        select.style.color = '#ffffff';
                        select.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    } else {
                        select.style.backgroundColor = '';
                        select.style.color = '';
                        select.style.borderColor = '';
                    }
                });
            }
            
            // é‡ç½®è¡¨å•æ ·å¼
            function resetFormStyles() {
                const inputs = document.querySelectorAll('input:not(.bg-select), textarea');
                const selects = document.querySelectorAll('select:not(.bg-select)');
                
                inputs.forEach(input => {
                    input.style.backgroundColor = '';
                    input.style.color = '';
                    input.style.borderColor = '';
                    input.style.setProperty('--placeholder-color', '');
                });
                
                selects.forEach(select => {
                    select.style.backgroundColor = '';
                    select.style.color = '';
                    select.style.borderColor = '';
                });
                
                const containers = document.querySelectorAll('.container');
                containers.forEach(container => {
                    container.style.color = '';
                });
            }
            
            // åˆå§‹è®¾ç½®
            updateFormStyles(savedBg ? getBrightness(savedBg) : 200);
            
            // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—é¢œè‰²äº®åº¦
            function getBrightness(color) {
                const col = color.charAt(0) === '#' ? color.substring(1, 7) : color;
                const r = parseInt(col.substring(0, 2), 16);
                const g = parseInt(col.substring(2, 4), 16);
                const b = parseInt(col.substring(4, 6), 16);
                return (r * 299 + g * 587 + b * 114) / 1000;
            }
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl+B æˆ– Cmd+B å¿«é€Ÿæ‰“å¼€èƒŒæ™¯é€‰æ‹©å™¨
                if ((e.ctrlKey || e.metaKey) && e.key === 'b' && bgSelect) {
                    e.preventDefault();
                    bgSelect.focus();
                }
                
                // Esc å…³é—­èƒŒæ™¯é€‰æ‹©å™¨
                if (e.key === 'Escape' && document.activeElement === bgSelect) {
                    bgSelect.blur();
                }
            });
        });
    </script>
</body>
</html>