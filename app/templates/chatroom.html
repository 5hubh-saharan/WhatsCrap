{% extends "base.html" %}

{% block content %}
<h2>Room: {{ room.name }}</h2>

<!-- 背景颜色选择器 -->
<div class="background-selector">
    <label for="bgColorSelect">Background Color:</label>
    <select id="bgColorSelect" class="bg-select">
        <option value="#252a34">Dark Blue</option>
        <option value="#59A52C">Green</option>
        <option value="#ffffff">White</option>
        <option value="#3a4252">Gray Blue</option>
        <option value="#101216">Dark Gray</option>
        <option value="#6fca3a">Light Green</option>
        <option value="#1a1a2e">Navy</option>
        <option value="#0f3460">Deep Blue</option>
    </select>
    <button id="resetBg" class="reset-btn">Reset</button>
</div>

<hr>

<h3>Messages:</h3>

<div id="chatContainer" class="chat-container">
    <ul id="messageList" class="message-list">
        {% for message in messages %}
            <li class="message-item {% if message.user_id|string == request.session.get('user_id') %}my-message{% else %}other-message{% endif %}">
                <div class="message-bubble">
                    <div class="message-header">
                        {% if message.user_id|string != request.session.get('user_id') %}
                        <strong class="message-username">{{ message.user.username }}</strong>
                        {% endif %}
                        <span class="message-time">{{ message.created_at.strftime('%H:%M') if message.created_at else '' }}</span>
                        {% if message.user_id|string == request.session.get('user_id') %}
                        <strong class="message-username">You</strong>
                        {% endif %}
                    </div>
                    <div class="message-content">{{ message.content }}</div>
                </div>
            </li>
        {% endfor %}
    </ul>
</div>

<hr>

<h3>Send a Message</h3>

<form id="messageForm" class="message-form">
    <div class="message-input-container">
        <input 
            id="messageInput" 
            type="text" 
            placeholder="Write your message and press Enter to send..." 
            required
            autocomplete="off"
            autofocus
        >
        <button type="submit" id="sendButton" class="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            <span class="button-text">Send</span>
        </button>
    </div>
    <div id="messageError" class="field-error"></div>
</form>

<script src="/static/js/chat.js"></script>

<script>
    // Connect WebSocket
    const roomId = "{{ room.id }}";
    const userId = "{{ request.session.get('user_id') }}";
    const username = "{{ request.session.get('username', 'User') }}";
    connectWebSocket(roomId, userId, username);
    
    // 设置背景颜色选择器
    const bgSelect = document.getElementById('bgColorSelect');
    const resetBtn = document.getElementById('resetBg');
    const chatContainer = document.getElementById('chatContainer');
    
    // 从localStorage读取保存的背景颜色
    const savedBg = localStorage.getItem('chatBackgroundColor');
    if (savedBg) {
        chatContainer.style.backgroundColor = savedBg;
        bgSelect.value = savedBg;
    }
    
    bgSelect.addEventListener('change', function() {
        const selectedColor = this.value;
        chatContainer.style.backgroundColor = selectedColor;
        localStorage.setItem('chatBackgroundColor', selectedColor);
    });
    
    resetBtn.addEventListener('click', function() {
        localStorage.removeItem('chatBackgroundColor');
        chatContainer.style.backgroundColor = '';
        bgSelect.value = '#252a34';
    });
</script>

{% endblock %}